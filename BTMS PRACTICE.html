<?php
// dashboard.php
session_start();
if (!isset($_SESSION['user_id'])) {
    header("Location: login.html");
    exit();
}
?>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Budget Tracker Management System</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <style>

        .navbar {
            background-color: #0f1d31;
        }

        .navbar-brand, .nav-link {
            color: #fff !important;
            font-weight: bold;
        }

        h1 {
            font-size: 2.5rem;
            color: #333;
            font-weight: bold;
        }

        .card {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease-in-out;
        }

        .card:hover {
            transform: scale(1.05);
        }

        .bg-income {
            background-color: #28a745;
        }

        .bg-expense {
            background-color: #dc3545;
        }

        .bg-budget {
            background-color: #007bff;
        }

        footer {
            background-color: #10213b;
            color: #faf8f8;
            padding: 1rem 0;
            position:relative;
            width: 100%;
        }
    </style>
</head>
<body id="page-login-index" style="background-image:url('55,jpg.png');background-attachment: fixed; object-fit:cover; background-size:cover;">

    
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-info bg-warning">
        <div class="container-fluid">
            <a class="navbar-brand" href="#" onclick="showSection('dashboard')">Budget Tracker Management System</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="showSection('dashboard')">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('income')">Income</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('expenses')">Expenses</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('budget')">Budget</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('view-transactions')">Transactions</a>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-danger" onclick="logout()">Logout</button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>



    <!-- Dashboard Section -->
    <div id="dashboard" class="container mt-5 section">
        <h1 class="text-center mb-4, text-white" >Dashboard</h1>
        <div class="row">
            <div class="col-md-4">
                <div class="card bg-income text-white mb-3">
                    <div class="card-header">Total Income</div>
                    <div class="card-body">
                        <h5 id="total-money" class="card-text">₱0.00</h5>
                        <p class="card-text">Your total money.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-expense text-white mb-3">
                    <div class="card-header">Total Expenses</div>
                    <div class="card-body">
                        <h5 id="total-expenses" class="card-text">₱0.00</h5>
                        <p class="card-text">Your total expenses.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-budget text-white mb-3">
                    <div class="card-header">Remaining Balance</div>
                    <div class="card-body">
                        <h5 id="remaining-balance" class="card-text">₱0.00</h5>
                        <p class="card-text">Your remaining balance.</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- Updated Dashboard Section for Allocations -->
        <div class="container mt-5 section"></div>
        <h1 class="text-center mb-4, text-white">Your Allocations</h1>
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card bg-warning text-dark mb-3">
                    <div class="card-header" id="allocated-expenses-header"></div>
                    <div class="card-body">
                        <h5 id="allocated-expenses" class="card-text">₱0.00</h5>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
            <div class="card bg-warning text-dark mb-3">
                    <div class="card-header" id="allocated-emergency-header"></div>
                    <div class="card-body">
                        <h5 id="allocated-emergency" class="card-text">₱0.00</h5>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
            <div class="card bg-warning text-dark mb-3">
                    <div class="card-header" id="allocated-investment-header"></div>
                    <div class="card-body">
                        <h5 id="allocated-investment" class="card-text">₱0.00</h5>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
            <div class="card bg-warning text-dark mb-3">
                    <div class="card-header" id="allocated-tithes-header"></div>
                    <div class="card-body">
                        <h5 id="allocated-tithes" class="card-text">₱0.00</h5>
                    </div>
                </div>
            </div>
        </div>

        <footer class="text-center">
            <p>MANAGE YOUR FINANCES SIMPLY AND WISELY!</p>
            <h4>"Whoever can be trusted with very little can also be trusted with much, and whoever is dishonest with very little will also be dishonest with much. So if you have not been trustworthy in handling worldly wealth, who will trust you with true riches?" <br>Luke 16:10-11</h4>
        </footer>
    </div>

    <!-- Income Section -->
    <div id="income" class="container mt-5 section" style="display: none;">
        <h1 class="text-center mb-4">Income</h1>
        <form id="income-form" action="add_transaction.php" method="POST" class="mt-4">
            <div class="form-group">
                <label for="income-category">Times You Received Money</label>
                <select class="form-select" id="income-category" required>
                    <option value="" disabled selected>Select Time</option>
                    <option value="Monthly">MONTHLY</option>
                    <option value="Weekly">WEEKLY</option>
                    <option value="Daily">DAILY</option>
                    <option value="today">ONLY TODAY</option>
                    <option value="other">OTHERS</option>
                </select>
                <input type="text" id="incomecat-specify" class="form-control mt-2" placeholder="Please specify" style="display:none;">
            </div>
            <div class="form-group">
                <label for="income-from">Where You Get Money</label>
                <select class="form-select" id="income-from" onchange="showIncomeSpecifyField()" required>
                    <option value="" disabled selected>Source Of Money</option>
                    <option value="Parents">PARENTS</option>
                    <option value="Scholarship">SCHOLARSHIP</option>
                    <option value="Part-Time Jobs">PART-TIME JOBS</option>
                    <option value="Others">OTHERS</option>
                </select>
                <input type="text" id="income-specify" class="form-control mt-2" placeholder="Please specify" style="display:none;">
            </div>
            <div class="form-group">
                <label for="income-amount">Your Total Money</label>
                <input type="number" class="form-control" id="income-amount" placeholder="Enter Total Amount" required>
            </div>
            <button type="submit" class="btn btn-primary mt-3">Add Income</button>
        </form>
    </div>

    <!-- Expenses Section -->
    <div id="expenses" class="container mt-5 section" style="display: none;">
        <h1 class="text-center mb-4">Expenses</h1>
        <form id="expense-form" action="add_transaction.php" method="POST"class="mt-4">
            <div class="form-group">
                <label for="expense-description">Description</label>
                <input type="text" class="form-control" id="expense-description" required>
            </div>
            <div class="form-group">
                <label for="expense-amount">Amount</label>
                <input type="number" class="form-control" id="expense-amount" required>
            </div>
            <div class="form-group">
                <label for="expense-category">Category</label>
                <select class="form-select" id="expense-category" onchange="showExpenseSpecifyField()" required>
                    <option value="" disabled selected>Select Category</option>
                    <option value="Food">Food</option>
                    <option value="Transport">Transport</option>
                    <option value="Others">Others</option>
                </select>
                <input type="text" id="expense-specify" class="form-control mt-2" placeholder="Please specify" style="display:none;">
            </div>
            <button type="submit" class="btn btn-primary mt-3">Add Expense</button>
        </form>      
    </div>

    <!-- Budget Section -->
    <div id="budget" class="container mt-5 section" style="display: none;">
        <h1 class="text-center mb-4">Budget</h1>
        <div class="row">
            <div class="col-md-4">
                <h3>Monthly Budget</h3>
                <p>Allocated <input type="number" id="expense-percent" value="60" style="width: 50px;">% for 
                <input type="text" id="expense-name" value="Expenses" style="width: 100px;"></p>
                <p>Allocated <input type="number" id="emergency-percent" value="20" style="width: 50px;">% for 
                <input type="text" id="emergency-name" value="Emergency Fund" style="width: 100px;"></p>
                <p>Allocated <input type="number" id="investment-percent" value="10" style="width: 50px;">% for 
                <input type="text" id="investment-name" value="Investment" style="width: 100px;"></p>
                <p>Allocated <input type="number" id="tithes-percent" value="10" style="width: 50px;">% for 
                <input type="text" id="tithes-name" value="Tithes" style="width: 100px;"></p>
                <button class="btn btn-primary mt-3" onclick="updateDashboardAllocations()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Transactions Section -->
    <section id="view-transactions" class="container mt-5 section" style="display: none;">
        <h1 class="text-center mb-4">Your Transactions</h1>
        <div class="card mt-4">
            <div class="card-header">Income/Money/Allowance Transactions</div>
            <div class="card-body">
                <table class="table table-striped">
                    <thead>
                      <tr>
                        <th>#</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Category</th>
                        <th>Date</th>
                      </tr>
                    </thead>
                    <tbody id="income-transaction-list">
                      <!-- Income Transaction rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card mt-4">
            <div class="card-header">Expense Transactions</div>
            <div class="card-body">
                <table class="table table-striped">
                    <thead>
                      <tr>
                        <th>#</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Category</th>
                        <th>Date</th>
                      </tr>
                    </thead>
                    <tbody id="expense-transaction-list">
                      <!-- Expense Transaction rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- JavaScript -->
    <script>
        let totalIncome = 0;
        let totalExpenses = 0;
        
        // Handle the income form submission
        document.getElementById('income-form').addEventListener('submit', function (e) {
            e.preventDefault();
            
            const incomeAmount = parseFloat(document.getElementById('income-amount').value);
            let incomeFrom = document.getElementById('income-from').value;
            let incomeCat = document.getElementById('income-category').value;

        if (incomeCat === "other") {
           const specifycat = document.getElementById('incomecat-specify').value;
         if (specifycat) {
                    incomeCat = specifycat;
        }
    }

            if (incomeFrom === 'Others') {
                const specifyIncome = document.getElementById('income-specify').value;
                if (specifyIncome) {
                    incomeFrom = specifyIncome;
                }
            }

            if (incomeAmount > 0) {
                totalIncome += incomeAmount;

                // Apply 60-20-10-10 Rule (based on current saved percentages)
                const budgetAllocations = JSON.parse(localStorage.getItem('budgetAllocations')) || {
                    expensePercent: 60,
                    emergencyPercent: 20,
                    investmentPercent: 10,
                    tithesPercent: 10
                };

                const expenses = totalIncome * (budgetAllocations.expensePercent / 100);
                const emergency = totalIncome * (budgetAllocations.emergencyPercent / 100);
                const investment = totalIncome * (budgetAllocations.investmentPercent / 100);
                const tithes = totalIncome * (budgetAllocations.tithesPercent / 100);

                // Update the dashboard with allocated amounts
                document.getElementById('allocated-expenses').textContent = `₱${expenses.toFixed(2)}`;
                document.getElementById('allocated-emergency').textContent = `₱${emergency.toFixed(2)}`;
                document.getElementById('allocated-investment').textContent = `₱${investment.toFixed(2)}`;
                document.getElementById('allocated-tithes').textContent = `₱${tithes.toFixed(2)}`;

                // Add the income transaction to the income section
                addTransaction(incomeFrom, incomeAmount, incomeCat, new Date().toLocaleDateString(), 'income');

                // Update the dashboard
                updateDashboard();
            }

            // Reset form after submission
            this.reset();
        });

        // Function to handle adding expenses
        document.getElementById('expense-form').addEventListener('submit', function (e) {
            e.preventDefault();

            const expenseAmount = parseFloat(document.getElementById('expense-amount').value);
            const description = document.getElementById('expense-description').value;
            let category = document.getElementById('expense-category').value;

            if (category === 'Others') {
                const specifyExpense = document.getElementById('expense-specify').value;
                if (specifyExpense) {
                    category = specifyExpense;
                }
            }

            if (expenseAmount > 0) {
                totalExpenses += expenseAmount;

                // Add the expense transaction
                addTransaction(description, expenseAmount, category, new Date().toLocaleDateString(), 'expense');

                // Update the dashboard
                updateDashboard();
            }

            // Reset form after submission
            this.reset();
        });

        // Function to update the dashboard
        function updateDashboard() {
            const remainingBalance = totalIncome - totalExpenses;

            document.getElementById('total-money').textContent = `₱${totalIncome.toFixed(2)}`;
            document.getElementById('total-expenses').textContent = `₱${totalExpenses.toFixed(2)}`;
            document.getElementById('remaining-balance').textContent = `₱${remainingBalance.toFixed(2)}`;
        }

        // Function to add transaction to the appropriate section
        function addTransaction(description, amount, category, date, type) {
            const transaction = { description, amount, category, date };

            let tableBody;
            if (type === 'income') {
                tableBody = document.getElementById('income-transaction-list');
            } else if (type === 'expense') {
                tableBody = document.getElementById('expense-transaction-list');
            }

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${tableBody.children.length + 1}</td>
                <td>${transaction.description}</td>
                <td>₱${transaction.amount.toFixed(2)}</td>
                <td>${transaction.category}</td>
                <td>${transaction.date}</td>
            `;
            tableBody.appendChild(row);
        }

        // Show specify field for Income "Others"
        function showIncomeSpecifyField() {
            const incomeSource = document.getElementById('income-from').value;
            document.getElementById('income-specify').style.display = incomeSource === 'Others' ? 'block' : 'none';
        }

        // Show specify field for Expenses "Others"
        function showExpenseSpecifyField() {
            const expenseCategory = document.getElementById('expense-category').value;
            document.getElementById('expense-specify').style.display = expenseCategory === 'Others' ? 'block' : 'none';
        }

        // Update dashboard with custom percentages and names and save to localStorage
        function updateDashboardAllocations() {
            const expensePercent = document.getElementById('expense-percent').value;
            const expenseName = document.getElementById('expense-name').value;
            const emergencyPercent = document.getElementById('emergency-percent').value;
            const emergencyName = document.getElementById('emergency-name').value;
            const investmentPercent = document.getElementById('investment-percent').value;
            const investmentName = document.getElementById('investment-name').value;
            const tithesPercent = document.getElementById('tithes-percent').value;
            const tithesName = document.getElementById('tithes-name').value;

            // Store updated budget allocations in localStorage
            localStorage.setItem('budgetAllocations', JSON.stringify({
                expensePercent,
                expenseName,
                emergencyPercent,
                emergencyName,
                investmentPercent,
                investmentName,
                tithesPercent,
                tithesName
            }));

            // Apply the changes to the dashboard
            document.getElementById('allocated-expenses').textContent = `${expensePercent}% for ${expenseName}`;
            document.getElementById('allocated-emergency').textContent = `${emergencyPercent}% for ${emergencyName}`;
            document.getElementById('allocated-investment').textContent = `${investmentPercent}% for ${investmentName}`;
            document.getElementById('allocated-tithes').textContent = `${tithesPercent}% for ${tithesName}`;

            // Reflect the changes dynamically on the dashboard lower part
            document.getElementById('allocated-expenses-header').textContent = `Allocated for ${expenseName} (${expensePercent}%)`;
            document.getElementById('allocated-emergency-header').textContent = `Allocated for ${emergencyName} (${emergencyPercent}%)`;
            document.getElementById('allocated-investment-header').textContent = `Allocated for ${investmentName} (${investmentPercent}%)`;
            document.getElementById('allocated-tithes-header').textContent = `Allocated for ${tithesName} (${tithesPercent}%)`;

            alert('Budget allocations saved!');
        }

        // Load saved budget allocations from localStorage on page load
        window.addEventListener('load', function() {
            const savedAllocations = localStorage.getItem('budgetAllocations');
            
            if (savedAllocations) {
                const { expensePercent, expenseName, emergencyPercent, emergencyName, investmentPercent, investmentName, tithesPercent, tithesName } = JSON.parse(savedAllocations);

                // Update input fields
                document.getElementById('expense-percent').value = expensePercent;
                document.getElementById('expense-name').value = expenseName;
                document.getElementById('emergency-percent').value = emergencyPercent;
                document.getElementById('emergency-name').value = emergencyName;
                document.getElementById('investment-percent').value = investmentPercent;
                document.getElementById('investment-name').value = investmentName;
                document.getElementById('tithes-percent').value = tithesPercent;
                document.getElementById('tithes-name').value = tithesName;

                // Update the dashboard display (upper part and lower part)
                document.getElementById('allocated-expenses-header').textContent = `Allocated for ${expenseName} (${expensePercent}%)`;
                document.getElementById('allocated-emergency-header').textContent = `Emergency Fund (${emergencyPercent}%)`;
                document.getElementById('allocated-investment-header').textContent = `Investment (${investmentPercent}%)`;
                document.getElementById('allocated-tithes-header').textContent = `Tithes (${tithesPercent}%)`;

                document.getElementById('allocated-expenses').textContent = `${expensePercent}% for ${expenseName}`;
                document.getElementById('allocated-emergency').textContent = `${emergencyPercent}% for ${emergencyName}`;
                document.getElementById('allocated-investment').textContent = `${investmentPercent}% for ${investmentName}`;
                document.getElementById('allocated-tithes').textContent = `${tithesPercent}% for ${tithesName}`;
            }
        });

        // Function to show sections
        function showSection(sectionId) {
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => section.style.display = 'none');
            document.getElementById(sectionId).style.display = 'block';
        }

        function logout() {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', 'logout.php', true);
            
            xhr.onload = function() {
                if (this.status === 200) {
                    alert(this.responseText); // Alert the response from the logout script
                    window.location.href = 'index.html'; // Redirect to login page
                }
            };

            xhr.send(); // Send the request
        }

    </script>
</body>
</html>